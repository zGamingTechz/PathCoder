{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='style_ide.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css">
<title>Web IDE</title>
{% endblock %}

{% block body %}
<a href="/" class="back-button">Back</a>

<div class="ide-container">
    <div class="ide-header">
        <h1>Web IDE</h1>
    </div>

    <div class="editor-container">
        <h2>Code Editor</h2>
        <textarea id="code-editor" placeholder="Write your code here..."></textarea>
    </div>

    <div class="buttons-container">
        <button id="run-button">Run</button>
        <button id="clear-button">Clear</button>
        <button id="download-button">Download</button>
    </div>

    <div class="output-container">
        <h2>Output</h2>
        <iframe id="output-frame"></iframe>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/clike/clike.min.js"></script>

<script>
    // Initialize CodeMirror with a dark theme
    var editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
        lineNumbers: true,
        mode: "{{ language|lower }}",
        theme: "dracula",
        matchBrackets: true,
        autoCloseBrackets: true
    });

    // Run the code in an iframe
    document.getElementById("run-button").addEventListener("click", function() {
        let code = editor.getValue();
        let outputFrame = document.getElementById("output-frame").contentWindow.document;
        outputFrame.open();
        outputFrame.write(code);
        outputFrame.close();

        let outputDoc = outputFrame.body;
        outputDoc.style.color = "green";
    });

    // Clear the editor and output
    document.getElementById("clear-button").addEventListener("click", function() {
        editor.setValue("");
        document.getElementById("output-frame").contentWindow.document.open();
        document.getElementById("output-frame").contentWindow.document.close();
    });

    // Download the code file with the appropriate extension
    document.getElementById("download-button").addEventListener("click", function() {
        let code = editor.getValue().trim();
        let extension = "{{ language|lower }}";

        let extMap = { "python": "py", "html": "html", "css": "css", "javascript": "js", "c++": "cpp", "c": "c", "c#": "cs"};
        let fileExt = extMap[extension] || "txt";

        let blob = new Blob([code], { type: "text/plain" });
        let a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `code.${fileExt}`;
        a.click();
    });
</script>

{% endblock %}
